# Trino concepts

## 1. Server types

There are two types of Trino servers: **coordinator** and **workers**. 

### 1.1 Coordinator

- Trino coordinator 是负责解析语句，计划查询和管理 worker 节点的服务器。
- 它是 Trino 的“大脑”，也是客户端连接到以提交执行语句的节点。
- coordinator 跟踪每个 worker 的活动并协调查询的执行。 coordinator 创建涉及一系列阶段的查询的逻辑模型，然后将其转换为在 Trino workers 上运行的一系列关联任务。
- coordinator 使用 REST API 与 workers 和 client 进行通信。
- ![未命名](/Users/zgl/Desktop/未命名.png)

### 1.2 Worker

- worker 负责执行任务和处理数据。
- workers 从连接器获取数据并相互交换数据。
- coordinator 负责从 worker 那里获取结果，并将最终结果返回给 client。
- 当 worker 进程启动时，它将自己告知 coordinator，coordinator 就可以使用它来执行任务。
- workers 使用 REST API 与 worker 和 coordinator 进行通信。

## 2. Data sources

### 2.1 Connector

- 连接器使 Trino 接入数据源，例如Hive或关系数据库。类似数据库驱动程序。
- 它是 Trino SPI 的实现，允许 Trino 使用标准 API 与资源进行交互。
  - 当您实现新的 Trino 插件时，将实现接口并覆盖 SPI 定义的方法。
- Trino 包含几个内置连接器：用于 JMX 的连接器，可访问内置系统表的 System 连接器，Hive 连接器和旨在提供 TPC-H 基准数据的 TPCH 连接器。 许多第三方开发人员都贡献了连接器，以便 Trino 可以访问各种数据源中的数据。
- 每个 catalog 都与一个特定的连接器相关联。
- 如果检查 catalog 配置文件，则会看到每个文件都包含强制性属性 connector.name，catalog 管理器使用该属性为给定 catalog 创建连接器。

### 2.2 Catalog

- Trino catalog 包含 schemas，和通过连接器引用数据源。
- 在 Trino 中查找表时，标准表名始终在 rooted catalog 中。

### 2.3 Schema

- schemas 是组织表的一种方式。
- catalog 和 schemas 共同定义了一组可以查询的表。

### 2.4 Table

- 表是一组无序的行，它们被组织成具有类型的命名列。 这与其他关系数据库中的相同。 
- 从源数据到表的映射由 connector 定义。

## 3. Query execution model

Trino 执行 SQL 语句并将这些语句转换为查询，这些查询将在 coordinator 和 workers 的分布式集群中执行。

### 3.1 Statement

- Trino 执行 ANSI 兼容的 SQL 语句。 当 Trino 引用一个语句时，它引用的是 ANSI SQL标准中定义的语句，该标准由子句，表达式和谓词组成。

- 在 Trino 中，语句仅指 SQL 语句的文本表示形式。
- 当执行一条语句时，Trino 会创建一个查询以及一个查询计划，然后将其分配给 workers。

### 3.2 Query

- 当 Trino 解析一条语句时，它将转换为查询并创建一个分布式查询计划。
- 查询包含 stages，tasks，splits，connectors 以及其他组件和数据源，它们协同工作以产生结果。

### 3.3 Stage

- 当 Trino 执行查询时，它通过将执行分解为 stages 层次结构来执行。
- 包含查询的 stages 的层次结构类似于一棵树。每个查询都有一个 root stage，该 stage 负责汇总其他 stages 的输出。

- stage 是 coordinate 用来为分布式查询计划建模的工具，但是 stage 本身并不在 Trino worker 上运行。

### 3.4 Task

- 要了解 stage 是如何执行的，需要了解 stage 是作为在 Trino worker 网络上分布的一系列 task 实现的。
- task 是Trino体系结构中的“work horse”，因为分布式查询计划被分解为一系列 stage ，然后转换为 task，然后对 task 进行操作或 split。

### 3.5 Split

### 3.6 Driver

- task 包含一个或多个并行驱动程序。
- driver 根据数据进行操作，并组合运算符以产生输出，然后将输出汇总到一个 task 中，然后在另一个 stage 将其交付给另一个task。
- driver 具有一个输入和一个输出。

### 3.7 Operator

- operator 消费，转换和产生数据。

### 3.8 Exchange

- 在 Trino 节点之间交换查询不同 stage 的传输数据。